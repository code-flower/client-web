<!-- TO DO

  - test cloc on a git repo, like in the curl example at http://codefellows.github.io/CodeFlower/
  - create node server that can a accept url of a git repo and automatically generate a flower from it
    - might need a configuration interface to set up the flower
      - e.g. to constrain really large codeflowers
      - to set which nodes should be opened/closed at the outset
  - add a popover somewhere with an explanation of what a codeflower is
  - this could be one tab in an app that analyzes the cisco app
    - add another tab for search page performance tracking
    - maybe another to track which apis are hit the most, at what frequency
  - maybe bring in angular or jquery

-->

<!DOCTYPE html>
<html>
  <head>
    <title>CodeFlower Source code visualization</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link type="text/css" rel="stylesheet" href="stylesheets/bootstrap.min.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="stylesheets/bootstrap-responsive.min.css" rel="stylesheet">
<!--     <link href='http://fonts.googleapis.com/css?family=Rosario:400,700' rel='stylesheet' type='text/css'>
 -->    <link type="text/css" rel="stylesheet" href="stylesheets/style.css"/>

    <style type="text/css">

      circle.node {
        cursor: pointer;
        stroke: #000;
        stroke-width: .5px;
      }

      circle.node.directory {
        stroke: #9ecae1;
        stroke-width: 2px;
      }

      circle.node.collapsed {
        stroke: #555;
      }

      .nodetext {
        fill: #252929;
        font-weight: bold;
        text-shadow: 0 0 0.2em white;
      }

      line.link {
        fill: none;
        stroke: #9ecae1;
        stroke-width: 1.5px;
      }

      body {
        text-align: center;
      }

      #project {
        position: fixed;
        top: 15px;
        left: 15px;
        width: 400px;
        font-size: 11px;
      }

      #visualization > svg > rect {
        stroke: none !important;
      }

    </style>
  </head>
  <body>
    <div class="content">
      <div class="container">
        <form class="form-inline">
          <fieldset>
          <select id="project"></select>
          </fieldset>
        </form>
        <div id="visualization"></div>
      </div>
    </div>
    <script type="text/javascript" src="bower_components/angular/angular.js"></script>
    <script type="text/javascript" src="javascripts/d3/d3.js"></script>
    <script type="text/javascript" src="javascripts/d3/d3.geom.js"></script>
    <script type="text/javascript" src="javascripts/d3/d3.layout.js"></script>
    <script type="text/javascript" src="javascripts/CodeFlower.js"></script>
    <script type="text/javascript" src="javascripts/dataConverter.js"></script>
    <script type="text/javascript">

      //// GLOBAL VARIABLES ////

      var currentCodeFlower;    // a CodeFlower object
      var allCode;              // an object to represent the structure of the entire codebase
      var codeStrings = [];     // a list of strings for the dropdown, constructed from allCode

      //// FUNCTIONS ////

      function deepCopy(data) {
        return JSON.parse(JSON.stringify(data));
      }

      function createCodeFlower(json) {
        // remove previous flower to save memory
        if (currentCodeFlower) currentCodeFlower.cleanup();

        // adapt layout size to the total number of elements
        var total = countElements(json);
        w = parseInt(Math.sqrt(total) * 30, 10) + 100;
        h = parseInt(Math.sqrt(total) * 30, 10) + 100;

        // vertically center the flower
        if (h < window.innerHeight) {
          var topMargin = (window.innerHeight - h) / 2.0;
          document.getElementById('visualization').style.marginTop = topMargin + 'px';
        }

        // create a new CodeFlower
        currentCodeFlower = new CodeFlower("#visualization", w, h).update(json);
      };

      // generates an array of codeStrings from allCode
      function parseCode() {
        (function recurse(code, codeStr) {
          if (code.children) {
            codeStr += code.name + '-';
            codeStrings.push(codeStr);
            for (var i = 0; i < code.children.length; i++)
              recurse(code.children[i], codeStr);
          }
        })(allCode, '');

        for (var i = 0; i < codeStrings.length; i++) {
          codeStrings[i] = codeStrings[i].slice(0, -1);
        }
      }

      // populates the dropdown with options
      function createDropdown() {
        var dropdown = document.getElementById('project');
        for (var i = 0; i < codeStrings.length; i++) {
          var opt = document.createElement('option');
          opt.text = codeStrings[i];
          opt.value = codeStrings[i];
          dropdown.add(opt);
        }
      }

      function redrawFlower(value) {
        var props = value.split('-');
        var code = allCode;
        for (var i = 1; i < props.length; i++)  {
          for (var j = 0; j < code.children.length; j++) {
            if (code.children[j].name === props[i]) {
              code = code.children[j];
              break;
            }
          }
        }
        createCodeFlower(deepCopy(code));
      }

      function generateFlower(file) {
        d3.json(file, function(data) {
          allCode = data;    
          parseCode();
          createDropdown();
          createCodeFlower(deepCopy(allCode));
        });
      }

      //// EVENT LISTENERS ////

      // respond to dropdown changes
      document.getElementById('project').addEventListener('change', function() {
        redrawFlower(this.value);
      });

      //// COMMANDS ////

      generateFlower('data/insights-frontend-src.json');

      var injector = angular.injector(['ng']);
      var $http = injector.get('$http');

      $http({
        method: 'GET',
        url: '/search'
      })
      .then(function(res) {
        console.log(res);
      });

    </script>
  </body>
</html>
